# 统一存档系统 (Unified Save System)

## 概述

统一存档系统是士郎跑酷游戏的完整存档解决方案，提供了以下核心功能：

- ✅ 修复的文本输入系统
- ✅ 增强的暂停功能（ESC键暂停，音乐继续播放）
- ✅ 完整的游戏状态保存/加载
- ✅ 英文界面支持
- ✅ 存档文件管理（重命名、删除、刷新）
- ✅ 异步文件操作和压缩
- ✅ 全面的错误处理和恢复
- ✅ 性能优化和监控

## 功能特性

### 1. 文本输入系统
- 支持键盘输入存档名称
- 实时字符显示和退格删除
- 输入验证和长度限制（最多25个字符）
- 自动大写转换和特殊字符过滤

### 2. 暂停系统
- ESC键暂停/恢复游戏
- 暂停期间音乐继续播放
- 完整的游戏状态捕获和恢复
- 暂停菜单UI

### 3. 存档管理
- 自定义存档名称
- 存档文件表格显示
- 重命名和删除功能
- 自动扫描和刷新
- 存档元数据显示（分数、距离、时间等）

### 4. 性能优化
- 异步文件操作（非阻塞UI）
- 数据压缩减少磁盘使用
- 进度指示器
- 内存管理和清理

### 5. 错误处理
- 全面的错误类型定义
- 自动重试机制
- 备份和恢复功能
- 用户友好的错误消息

## 使用方法

### 游戏中操作

1. **暂停游戏**：
   - 在游戏进行中按 `ESC` 键暂停
   - 再次按 `ESC` 键恢复游戏

2. **保存游戏**：
   - 暂停游戏后点击 "Save Game" 按钮
   - 输入自定义存档名称（或使用默认名称）
   - 点击 "Save" 确认保存

3. **加载游戏**：
   - 从主菜单点击 "Load Game"
   - 从表格中选择要加载的存档
   - 点击 "Load" 按钮加载游戏

4. **管理存档**：
   - 在加载界面可以重命名、删除存档
   - 点击 "Refresh" 刷新存档列表
   - 点击 "Back" 返回主菜单

### 键盘快捷键

- `ESC`: 暂停/恢复游戏
- `Enter`: 确认输入
- `Backspace`: 删除字符
- `Space`: 输入下划线（在存档名称中）

## 技术实现

### 系统架构

```
统一存档系统
├── 输入处理 (Input Processing)
├── 文本处理 (Text Processing)  
├── 状态捕获 (State Capture)
├── 文件操作 (File Operations)
├── UI更新 (UI Update)
├── 音频管理 (Audio Management)
└── 错误处理 (Error Handling)
```

### 核心组件

1. **TextInputState**: 文本输入状态管理
2. **CompleteGameState**: 完整游戏状态数据结构
3. **SaveFileManager**: 存档文件管理器
4. **AsyncFileManager**: 异步文件操作管理器
5. **ErrorRecoveryManager**: 错误恢复管理器

### 数据格式

存档文件采用JSON格式，包含：
- 版本信息
- 元数据（名称、分数、时间等）
- 完整游戏状态
- 校验和（用于完整性验证）

可选择启用gzip压缩以减少文件大小。

## 配置选项

### 异步文件操作
```rust
AsyncFileManager {
    compression_enabled: true,    // 启用压缩
    compression_level: 6,         // 压缩级别 (1-9)
    max_concurrent_operations: 4, // 最大并发操作数
    operation_timeout_seconds: 30,// 操作超时时间
}
```

### 自动保存
```rust
AutoSaveConfig {
    enabled: true,              // 启用自动保存
    interval_seconds: 300.0,    // 自动保存间隔（5分钟）
    max_auto_saves: 5,          // 最大自动保存数量
}
```

### 错误处理
```rust
ErrorRecoveryManager {
    max_retries: 3,             // 最大重试次数
    backup_directory: "saves/backup", // 备份目录
}
```

## 文件结构

```
saves/
├── MyGame.json              # 用户存档文件
├── AutoSave_1.json         # 自动保存文件
├── backup/                 # 备份目录
│   ├── MyGame_backup.json
│   └── AutoSave_1_backup.json
└── temp/                   # 临时文件目录
```

## 性能监控

系统包含内置的性能监控功能：

- **帧率监控**: 目标60 FPS
- **操作时间**: 保存/加载操作时间跟踪
- **内存使用**: UI节点清理和内存管理
- **错误统计**: 错误类型和频率统计

## 错误处理

### 常见错误类型

1. **文件操作错误**:
   - 文件未找到
   - 权限被拒绝
   - 磁盘空间不足

2. **数据错误**:
   - 文件损坏
   - 校验和不匹配
   - 版本不兼容

3. **输入错误**:
   - 无效文件名
   - 名称已存在

### 恢复策略

- **自动重试**: 对于临时性错误
- **备份恢复**: 对于文件损坏
- **用户提示**: 对于需要用户干预的错误

## 测试

系统包含全面的测试套件：

### 单元测试
- 文本输入处理测试
- 游戏状态序列化测试
- 文件操作测试
- 英文文本常量测试
- 错误处理测试

### 集成测试
- 完整的暂停-保存-恢复工作流测试
- 主菜单-加载-游戏工作流测试
- UI状态转换测试
- 错误场景测试

运行测试：
```bash
cargo test
```

## 开发指南

### 添加新的存档数据

1. 更新 `CompleteGameState` 结构体
2. 确保新字段实现 `Serialize` 和 `Deserialize`
3. 更新版本号以保持兼容性
4. 添加相应的测试

### 添加新的错误类型

1. 在 `SaveSystemError` 枚举中添加新变体
2. 更新 `to_user_message()` 方法
3. 更新 `get_details()` 方法
4. 添加相应的恢复策略

### 性能优化建议

1. 使用异步操作避免阻塞UI
2. 启用压缩减少磁盘I/O
3. 定期清理临时文件和UI节点
4. 监控性能指标并优化瓶颈

## 故障排除

### 常见问题

1. **存档文件无法保存**:
   - 检查磁盘空间
   - 验证文件权限
   - 查看错误日志

2. **加载存档失败**:
   - 检查文件是否存在
   - 验证文件完整性
   - 尝试从备份恢复

3. **文本输入不响应**:
   - 确认输入框已激活
   - 检查键盘输入系统状态
   - 重启游戏

4. **性能问题**:
   - 检查FPS监控
   - 清理临时文件
   - 调整压缩设置

### 调试信息

启用调试日志：
```rust
// 在main.rs中添加
use bevy::log::LogPlugin;

app.add_plugins(DefaultPlugins.set(LogPlugin {
    level: bevy::log::Level::DEBUG,
    ..default()
}));
```

## 更新日志

### v1.0.0 (当前版本)
- ✅ 完整的统一存档系统实现
- ✅ 英文界面支持
- ✅ 异步文件操作
- ✅ 压缩和性能优化
- ✅ 全面的错误处理
- ✅ 综合测试套件

## 贡献

欢迎提交问题报告和功能请求。在提交代码更改之前，请确保：

1. 运行所有测试并通过
2. 遵循代码风格指南
3. 添加适当的文档和注释
4. 更新相关的测试用例

## 许可证

本项目采用MIT许可证。详见LICENSE文件。