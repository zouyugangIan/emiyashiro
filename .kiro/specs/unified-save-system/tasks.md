# 统一存档系统实现计划

- [x] 1. 修复文本输入系统


  - [x] 1.1 实现键盘输入处理器


    - 创建 TextInputState 资源来跟踪当前输入状态
    - 实现 handle_keyboard_input 系统处理字符输入和特殊键
    - 添加输入验证和字符过滤功能
    - 实现实时文本显示更新
    - _Requirements: 1.1, 1.2, 1.3, 7.1, 7.2, 7.3_

  - [x] 1.2 创建输入验证系统

    - 实现 InputValidator 结构体进行存档名称验证
    - 添加字符长度限制和无效字符过滤
    - 创建默认名称处理逻辑
    - 实现重复名称检测
    - _Requirements: 1.4, 1.5, 9.4_

- [x] 2. 创建英文文本常量系统


  - [x] 2.1 定义统一的英文文本常量


    - 创建 UnifiedSaveText 结构体包含所有UI文本
    - 定义主菜单、暂停菜单、对话框的英文标签
    - 添加错误消息和状态消息的英文文本
    - 创建表格列标题的英文常量
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

  - [x] 2.2 更新现有UI使用英文文本


    - 替换所有中文文本为英文常量引用
    - 更新按钮标签、菜单项和消息显示
    - 确保错误消息使用英文显示
    - 验证所有界面文本正确显示
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 3. 增强暂停系统


  - [x] 3.1 实现完整的游戏状态捕获


    - 创建 CompleteGameState 结构体包含所有游戏数据
    - 实现玩家位置、速度、动画状态的捕获
    - 添加摄像机状态和游戏指标的保存
    - 实现游戏实体状态的快照功能
    - _Requirements: 2.1, 2.3, 2.4, 10.1_

  - [x] 3.2 实现暂停/恢复功能

    - 修改 handle_pause_input 系统支持ESC键暂停
    - 实现游戏状态的完整恢复功能
    - 确保音频在暂停期间继续播放
    - 添加暂停状态的视觉指示
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 10.3, 10.4_

- [x] 4. 修复保存对话框功能


  - [x] 4.1 重建保存对话框UI


    - 创建功能正常的 SaveDialog 组件
    - 实现 SaveNameInputBox 组件支持键盘输入
    - 添加保存确认和取消按钮
    - 确保对话框使用英文文本显示
    - _Requirements: 3.1, 3.2, 6.3_

  - [x] 4.2 实现保存对话框交互

    - 修复文本输入字段的键盘响应
    - 实现保存名称验证和错误处理
    - 添加保存成功/失败的消息显示
    - 实现对话框的正确状态转换
    - _Requirements: 3.2, 3.3, 3.4, 3.5_

- [x] 5. 增强加载表格界面


  - [x] 5.1 重建加载表格UI


    - 创建 LoadTableRoot 组件支持表格显示
    - 实现 SaveFileRow 组件显示存档信息
    - 添加列标题使用英文文本
    - 实现表格行选择和高亮功能
    - _Requirements: 4.1, 4.2, 5.1, 5.5, 6.3_

  - [x] 5.2 实现存档文件管理功能

    - 添加重命名按钮和对话框功能
    - 实现删除按钮和确认机制
    - 添加刷新按钮重新扫描存档文件
    - 实现"No save files found"消息显示
    - _Requirements: 4.3, 4.4, 4.5, 5.5_

- [x] 6. 实现重命名对话框系统



  - [x] 6.1 创建重命名对话框UI



    - 创建 RenameDialog 组件和输入框
    - 实现预填充当前存档名称功能
    - 添加重命名确认和取消按钮
    - 确保对话框使用英文文本
    - _Requirements: 4.1, 4.2, 6.3_

  - [x] 6.2 实现重命名功能

    - 实现重命名输入的键盘处理
    - 添加重命名验证和冲突检测
    - 实现文件系统的重命名操作
    - 添加重命名成功/失败的错误处理
    - _Requirements: 4.2, 4.5, 8.4, 9.4_

- [x] 7. 完善文件系统集成


  - [x] 7.1 实现存档文件操作


    - 确保saves目录的自动创建
    - 实现存档文件的创建和写入
    - 添加存档文件的删除功能
    - 实现存档文件的重命名操作
    - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

  - [x] 7.2 实现存档文件扫描

    - 创建启动时的存档文件扫描功能
    - 实现存档元数据的读取和解析
    - 添加损坏文件的检测和处理
    - 实现存档文件列表的更新机制
    - _Requirements: 8.2, 9.3, 5.5_

- [x] 8. 实现从主菜单加载功能


  - [x] 8.1 更新主菜单加载按钮


    - 修改主菜单的"Load Game"按钮功能
    - 实现从主菜单到加载表格的状态转换
    - 确保加载界面正确显示存档列表
    - 添加返回主菜单的功能
    - _Requirements: 5.1, 5.5_

  - [x] 8.2 实现存档加载功能


    - 实现从存档文件恢复完整游戏状态
    - 添加加载过程的进度指示
    - 实现从加载表格直接进入游戏的转换
    - 确保音频状态在加载时正确恢复
    - _Requirements: 5.2, 5.3, 5.4, 10.2, 10.5_

- [x] 9. 实现音频连续性管理


  - [x] 9.1 创建音频状态管理


    - 实现音频位置和播放状态的保存
    - 确保暂停时背景音乐继续播放
    - 添加音频状态到游戏状态保存中
    - 实现音频状态的恢复功能
    - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

  - [x] 9.2 测试音频行为

    - 验证暂停期间音乐继续播放
    - 测试恢复时音频的无缝播放
    - 验证存档加载时音频状态恢复
    - 确保所有状态转换中音频正常工作
    - _Requirements: 10.3, 10.4, 10.5_

- [x] 10. 实现全面错误处理

  - [x] 10.1 创建错误处理系统


    - 定义 SaveSystemError 枚举包含所有错误类型
    - 实现错误到用户消息的转换
    - 创建 ErrorRecoveryManager 处理错误恢复
    - 添加备份和恢复机制
    - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_

  - [x] 10.2 实现具体错误处理

    - 添加文件操作失败的错误处理
    - 实现存档损坏的检测和处理
    - 添加权限错误的用户友好消息
    - 实现重试机制和回退策略
    - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_


- [ ] 11. 创建综合测试套件
  - [x] 11.1 编写单元测试


    - 测试文本输入处理和验证功能
    - 测试游戏状态序列化和反序列化
    - 测试文件操作和错误处理
    - 测试英文文本常量的完整性
    - _Requirements: All requirements verification_

  - [x] 11.2 编写集成测试


    - 测试完整的暂停-保存-恢复工作流
    - 测试主菜单-加载-游戏工作流
    - 测试所有UI状态转换和用户交互
    - 测试错误场景和恢复机制
    - _Requirements: All requirements verification_



- [ ] 12. 性能优化和最终集成
  - [x] 12.1 优化系统性能


    - 实现异步文件操作防止UI阻塞
    - 添加存档文件压缩减少磁盘使用
    - 优化游戏状态捕获的性能影响
    - 添加长时间操作的进度指示器
    - _Requirements: Performance optimization_

  - [x] 12.2 最终集成和完善



    - 将所有系统与现有游戏架构集成
    - 更新系统调度确保正确的执行顺序
    - 添加最终的UI完善和一致的样式
    - 执行所有功能的综合测试
    - _Requirements: Final integration and polish_