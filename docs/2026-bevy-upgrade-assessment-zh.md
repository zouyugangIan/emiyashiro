# 《EmiyaShiro（Bevy）2026 全面评估与长期升级蓝图》

> 版本：v1.0（代码审计基线）  
> 审计日期：2026-02-16  
> 基线提交：`96eb551`  
> 审计范围：`src/`、`Cargo.toml`、`README.md`、`.kiro/specs/`、构建与测试链路

> 说明：本文件是“基线审计快照”。当前实时状态请以  
> `docs/2026-upgrade-status.md` 与 `docs/2026-architecture-upgrade-tasks.md` 为准。

---

## 1) 结论先行（Executive Summary）

当前项目已经具备“可运行 + 有基础玩法 + 有联机雏形 + 有存档体系”的基础盘，但**距离 2026 年 Bevy 生产级最佳实践仍有明显差距**。最大问题不在“功能数量”，而在：

1. **系统耦合高、架构未收敛**（大量大文件/重复逻辑/未接入模块）。
2. **联机链路存在关键缺陷**（握手与状态同步不完整，输入发送重复，连接状态管理不准确）。
3. **玩法闭环未闭合**（死亡、受击、成长、关卡节奏与目标层不足）。
4. **工程保障不足**（测试已出现编译断裂、文档漂移、CI未围绕Rust游戏工程构建）。

如果目标是“长期升级 + 游戏好玩 + 功能最强”，建议先进行 8~12 周的“稳定性与架构重整”，再进入“内容与体验爆发期”。

---

## 2) 审计方法与证据

### 2.1 执行的检查

- 静态代码审计（架构、调度、状态机、联机、存档、UI、AI、音频、测试）
- 编译检查：
  - `cargo check`
  - `cargo check --all-features`
  - `cargo clippy --lib --all-features`
  - `cargo test --lib`
- 代码规模与风险点计数（文件规模、`unwrap/expect`、`println!`等）

### 2.2 核心结果

- `cargo check`：通过（有警告）。
- `cargo check --all-features`：通过（提示 `redis v0.23.3` future-incompat）。
- `cargo clippy --lib --all-features`：56 个警告（结构复杂度、未用代码、可派生实现、参数过多等）。
- `cargo test --lib`：**失败**（结构体字段更新后测试未同步）。

失败定位：`src/tests/menu_ui_tests.rs:13` 初始化 `GameAssets` 时缺失 `shirou_atlas_run`；该字段定义于 `src/resources.rs:80`。

---

## 3) 基线量化画像

### 3.1 代码体量

- `src/` 文件数：75
- `src/` 总行数：13,735
- 300 行以上文件：16

### 3.2 结构热点（可维护性风险）

- 超大文件：
  - `src/systems/ui.rs`（2013 行）
  - `src/systems/menu.rs`（516 行）
  - `src/systems/input.rs`（512 行）
  - `src/resources.rs`（472 行）
- 客户端入口调度过重：`src/bin/client.rs:12` 到 `src/bin/client.rs:296`

### 3.3 稳定性风险指标

- `unwrap(`：33 次
- `expect(`：13 次
- `println!`：255 次（高频实时系统中偏多）
- TODO：4 处（含关键玩法未实现）

---

## 4) 2026 最佳实践对照评分（0~10）

| 维度                | 当前评分 | 结论                                     |
| ------------------- | -------: | ---------------------------------------- |
| 引擎/版本策略       |        6 | 已在 Bevy 0.17，但未规划到 0.18 迁移窗口 |
| ECS 架构与模块化    |        4 | 大量系统集中在入口与大文件，插件化不足   |
| 调度与确定性        |        4 | `Update` 过载，固定步长/系统排序策略不足 |
| 联机架构            |        3 | 握手与状态管理存在功能性缺陷             |
| 存档系统            |        5 | 有新版格式与校验，但路径重复、流程并存   |
| 玩法深度（好玩性）  |        4 | 核心动作在，闭环与成长不足               |
| 性能/资源管线       |        4 | UI重建、日志噪音、阻塞I/O路径明显        |
| 质量保障（测试/CI） |        3 | 测试编译已断，CI缺少Rust游戏专项流程     |
| 文档与可运维性      |        3 | 文档版本漂移，部分链接/目录失效          |
| 生产可用性（长期）  |        4 | 可迭代，但需先做稳定性工程               |

**总评：40/100（可运行原型 + 中期可重构，不宜直接扩内容冲刺）**

---

## 5) 关键缺陷清单（按优先级）

## 5.1 P0（必须先修）

1. **测试链路已断裂（基础质量门禁失效）**
   - 证据：`src/tests/menu_ui_tests.rs:13` 与 `src/resources.rs:80` 字段不一致。
   - 影响：后续升级无法可靠回归。

2. **服务端握手包未真正发送，客户端ID流程不完整**
   - 证据：`src/bin/server.rs:170` 仅构造 `_welcome`；未写入socket。
   - 影响：`src/systems/network.rs:119` 中本地ID逻辑可能长期不成立。

3. **连接状态提前置为 Connected（错误状态机）**
   - 证据：`src/systems/network.rs:92` 在异步连接结果返回前即设为 `Connected`。
   - 影响：UI、重连策略、错误处理全部被误导。

4. **同一帧存在双路径输入上报，可能重复发包**
   - 证据：
     - `src/bin/client.rs:63` 调度 `send_player_input`
     - `src/bin/client.rs:236` 调度 `update_game_input`
     - `src/systems/input.rs:174` 与 `src/systems/network.rs:237` 都在发送 `PlayerAction`
   - 影响：网络噪声、带宽浪费、服务端动作抖动。

## 5.2 P1（高优先）

1. **玩法闭环未闭合（死亡/受击未完成）**
   - 证据：
     - `src/systems/death.rs:16`（死亡界面/流程 TODO）
     - `src/systems/combat.rs:185`（玩家扣血 TODO）
   - 影响：无法形成完整挑战反馈，降低可玩性。

2. **存档体系并存且路径分裂（Legacy + Async + PauseSave）**
   - 证据：
     - `src/systems/save.rs:6`（旧路径）
     - `src/systems/async_tasks.rs:25`（异步路径）
     - `src/systems/pause_save.rs:10`（暂停快照路径）
     - `src/bin/client.rs:204` 与 `src/bin/client.rs:228` 同时调度
   - 影响：状态一致性与维护成本风险高。

3. **WASM 联机路径未实现，跨平台承诺未兑现**
   - 证据：`src/systems/network.rs:96` 空实现。

4. **Redis 同步为阻塞式并且每次建连接**
   - 证据：
     - `src/systems/sync_redis.rs:26` 每实体每帧调用
     - `src/database/redis.rs:22` 到 `src/database/redis.rs:24` 每次 `set` 新建连接
   - 影响：主线程卡顿风险，吞吐不可控。

5. **UI性能热点：每帧销毁重建进度UI**
   - 证据：`src/systems/async_file_ops.rs:108` 到 `src/systems/async_file_ops.rs:111`。

## 5.3 P2（中优先）

1. **调度体系存在“设计文件化”但未落地接线**
   - 证据：
     - `src/systems/final_integration.rs:266` 定义插件入口
     - `src/systems/interfaces.rs` / `src/systems/system_sets.rs` 大量调度定义
     - 在 `src/bin/client.rs`、`src/bin/server.rs` 无实际接入调用

2. **碰撞系统定义与实际调度脱节**
   - 证据：`src/systems/collision.rs:80` 定义主碰撞系统，但客户端主调度未挂接该系统。

3. **文档漂移与工程可理解性下降**
   - 证据：
     - README 写 Bevy 0.16：`README.md:21`，而依赖是 0.17：`Cargo.toml:19`
     - README 指向 `main.rs`：`README.md:54`（项目实际为 `client/server` bin）
     - README 指向不存在的 `.kiro/steering`：`README.md:66`

---

## 6) 相对 2026 Bevy 最佳实践的差距

## 6.1 引擎与版本治理

当前在 Bevy 0.17，已不算落后，但 2026 年建议进入 **0.18 迁移窗口**，并建立“每个次版本一次迁移分支 + 回归基线”流程。

建议：

- 建立 `upgrade/bevy-0.18` 分支，先“编译通过”，再“行为一致性测试”。
- 把版本升级纳入 CI matrix（`stable` + `nightly -Z minimal-versions` 可选）。

## 6.2 ECS/插件化架构

最佳实践是“按领域插件 + 领域资源 + 明确系统集排序”。当前入口调度过重，且“接口/系统集定义”和“实际调度”分离。

建议目标结构：

- `GameplayPlugin`（输入/移动/战斗/死亡）
- `UiPlugin`（菜单/HUD/对话框）
- `NetcodePlugin`（连接/收包/预测/插值）
- `PersistencePlugin`（存档/恢复/云端）
- `PresentationPlugin`（动画/音频/VFX）

## 6.3 固定步长与确定性

当前核心动作多在 `Update`。2026 实战通常将物理/碰撞放到固定步长（`FixedUpdate`），渲染插值留在 `Update`。

建议：

- `FixedUpdate`：输入采样缓存、物理推进、碰撞、战斗命中。
- `Update`：动画状态机、镜头插值、UI、音效触发。

## 6.4 联机与可扩展在线功能

目前联机更接近“原型同步”。若目标“功能最强”，应演进到：

- 权威服 + 客户端预测 + 回滚/重演（至少位置层）
- 明确协议版本、重连恢复、心跳超时、限速与反作弊
- 区分“可靠事件”和“高频状态快照”

## 6.5 存档与数据可靠性

优点：已有 `SaveFileData`、版本号、校验和。  
不足：多套流程并存，职责边界不清。

建议：

- 明确单一事实来源（SSOT）：统一仅保留 `SaveFileData v2`。
- Legacy 仅保留“导入器”，不再参与主流程。
- 本地存档、云存档、会话快照三者拆层。

## 6.6 性能与资源管线

瓶颈不在渲染本身，而在“调度和逻辑开销”：

- 高频 `println!`
- UI 每帧重建
- 阻塞 I/O（Redis、文件路径）

建议：

- 日志分级 + 采样（release 默认降噪）
- UI 改为“状态变化驱动更新”
- Redis 改异步连接池/后台任务队列

---

## 7) “游戏好玩 + 功能最强”产品层建议

## 7.1 先补“好玩闭环”

当前已有动作基础（跑、跳、蹲、射击、Shroud），但缺少高质量循环：

**建议闭环（最小可玩2.0）**

1. 30 秒内出现“明确目标 + 风险决策”
2. 2 分钟内出现“强反馈高潮”（精英/小Boss）
3. 失败后给“成长收益”与“短期追目标”

## 7.2 强化 Shirou 特色（差异化）

把“圣骸布/Overedge”做成高风险高收益核心系统：

- 常态：安全、低伤、连段稳定
- 释放态：高伤、强位移、持续扣血（当前已有雏形）
- 关键：加入“收刀窗口”“完美规避增益”“反打奖励”

## 7.3 内容深度（中长期）

- 敌人谱系：近战追击、远程压制、地形控制、精英机制
- 关卡结构：事件房、分支路线、可破坏/可交互场景
- 元进度：天赋盘、武器词缀、剧情解锁
- 在线功能：排行榜、幽灵回放、协作挑战

---

## 8) 长期升级路线图（建议 12 个月）

## 阶段 A（0~4 周）：稳定性止血

目标：让“可持续开发”成立。

- 修复测试编译断裂（先恢复 `cargo test --lib`）
- 修复握手欢迎包发送与连接状态机
- 合并输入发送路径（保留一条）
- 补齐死亡/受击最小闭环（无 TODO）
- 建立 CI 最小门禁：`check + clippy + test`

## 阶段 B（5~10 周）：架构收敛

目标：降低熵增，提升演进速度。

- 入口插件化（Gameplay/UI/Netcode/Persistence/Presentation）
- 固定步长迁移（物理/战斗/碰撞）
- 存档单路径化（Legacy 转导入器）
- 拆分 `ui.rs` 与 `input.rs` 大文件

## 阶段 C（11~20 周）：玩法升级

目标：把“能玩”升级为“想反复玩”。

- 完成 3 种敌人 + 1 精英 + 1 Boss
- 加入局内构筑（3~5 个流派）
- 完成教程与新手前 5 分钟引导
- 增加高质量反馈（镜头、音效、命中、受击）

## 阶段 D（21~32 周）：在线与生态

目标：功能最强的基础设施。

- 协作/竞速模式
- 排行榜 + 回放系统
- 云存档与跨设备
- 反作弊基础策略

## 阶段 E（33~52 周）：运营化

- 数据埋点与平衡迭代
- 赛季活动与新内容节奏
- 性能预算长期守护（平台矩阵）

---

## 9) 技术任务清单（可直接排期）

## 9.1 架构

- [ ] 新建 `src/plugins/`，逐域迁移注册逻辑。
- [ ] `client.rs` 仅保留 app 启动与插件挂载。
- [ ] 删除未接线模块或补接线（`final_integration`、`interfaces`）。

## 9.2 联机

- [ ] 发送真实 `Welcome` 包（并在客户端确认握手完成）。
- [ ] `NetworkStatus` 由真实连接事件驱动更新。
- [ ] 统一输入发送通道（事件节流 + 差量发送）。
- [ ] 完成 `wasm32` 网络实现。

## 9.3 玩法

- [ ] 完成玩家受击与生命系统闭环。
- [ ] 增加 `GameOver`/`Revive` 状态。
- [ ] 重构敌人与子弹碰撞为统一命中管线。

## 9.4 存档

- [ ] 保留 `SaveFileData v2` 为唯一写入格式。
- [ ] 旧格式只读导入后自动迁移。
- [ ] 建立 save schema 回归测试。

## 9.5 性能

- [ ] 进度UI改增量更新，不再每帧重建。
- [ ] Redis 改连接复用与异步批量写。
- [ ] release 默认关闭高频 debug `println!`。

## 9.6 质量工程

- [ ] CI：`cargo fmt --check`、`cargo clippy`、`cargo test --lib`
- [ ] 为玩法核心（移动/碰撞/伤害/状态机）补充行为测试。
- [ ] 建立“版本升级回归清单”。

---

## 10) 成功度量（必须量化）

## 10.1 工程质量 KPI

- `cargo test --lib`：100% 可编译、可运行。
- clippy 高危告警：0（自定义 deny 列表）。
- 关键模块平均文件行数 < 400。

## 10.2 性能 KPI

- 1080p 下单机场景帧时间 P95 < 16.6ms。
- 在线 8 人场景帧时间 P95 < 20ms。
- 存档操作主线程卡顿 < 2ms（P95）。

## 10.3 可玩性 KPI

- 新用户 10 分钟留存 > 60%。
- 30 分钟留存 > 35%。
- 平均每局时长 > 8 分钟（首阶段目标）。

---

## 11) 风险与缓解

1. **重构期间功能回退**
   - 缓解：先建回归测试，再拆入口。

2. **联机复杂度大幅上升**
   - 缓解：先“握手/状态机/输入节流”三件套，再做预测校正。

3. **内容扩张压垮工程节奏**
   - 缓解：采用“每两周一条可玩增量”节奏，而非一次性大版本。

---

## 12) 未来两周（最小可执行计划）

第 1 周：

- 修复测试编译（`GameAssets` 初始化）
- 修复 `Welcome` 发送与连接状态
- 去重输入发送路径

第 2 周：

- 补死亡/受击闭环
- 把碰撞与战斗迁入固定步长
- 建立 CI 门禁与文档更新

---

## 13) 外部参考（2026）

- Bevy 0.18 发布说明（官方）：https://bevy.org/news/bevy-0-18/
- Bevy 0.17 -> 0.18 迁移指南（官方）：https://bevy.org/learn/migration-guides/0-17-to-0-18/

> 说明：本评估采用“先稳定、再增强、后扩张”的长期策略；如果要实现“好玩 + 功能最强”，不建议跳过稳定性阶段直接堆功能。
