# 2026 引擎架构升级 TASKS

> 基线日期：2026-02-24  
> 输入文档：`docs/2026-upgrade-status.md`、`docs/bevy-upgrade-regression-checklist.md`、`docs/ops-runbook.md`、`SCENE_ENHANCEMENT.md`  
> 指标报告：`docs/2026-architecture-metrics-report.md`

## 1) 目标与原则

目标：在保证“可运行 + 可回归”的前提下，持续升级到 2026 可运营架构。

原则：

- 先稳定，再扩功能。
- 每个任务必须有可验证验收标准。
- 优先改造高风险链路（网络、调度、存档一致性）。

## 2) 当前状态快照

### 已完成（本轮）

- [x] 服务端运行时插件化（`src/plugins/server.rs`）
- [x] 服务端固定步长 60Hz（`FixedUpdate`）
- [x] 客户端自动重连（冷却窗口）
- [x] 客户端心跳 Ping 管线
- [x] 存档零 legacy 化（仅 `SaveFileData v2` + 强校验）
- [x] 严格质量门禁（`clippy -D warnings` + `test --all-features`）

### 进行中

- [x] 联机层“预测 + 服务器校正”主链路
- [x] 快照差量/压缩同步
- [x] 会话恢复（断线后状态续接）

## 3) P0（两周内）

### T-001 客户端预测与服务器校正（位置层）

- 优先级：P0
- 目标：本地输入即时反馈，服务端快照到达后做平滑校正。
- 验收：
  - [x] 已接入位置层客户端预测（本地输入立即驱动本地主角）。
  - [x] 已实现误差分级校正：deadzone 忽略 / smooth 回拉 / 大偏差 snap。
  - [x] 网络压测与体验指标已补齐（首帧延迟、抖动、纠偏频次）。

### T-002 网络会话恢复（Reconnect Resume）

- 优先级：P0
- 目标：在自动重连成功后恢复玩家网络身份与必要状态。
- 验收：
  - [x] 断线后 5 秒内重连可自动回到 Playing 流程。
  - [x] `MyNetworkId` 与实体映射恢复，不产生重复实体。
  - [x] `NetworkStatus` 全程与真实连接事件一致。

### T-003 输入同步协议升级（事件 + 状态分层）

- 优先级：P0
- 目标：区分“持续状态输入”和“瞬时事件输入”。
- 验收：
  - [x] 移动输入采用状态流（节流/差量）。
  - [x] 跳跃/攻击采用事件流（一次触发一次发送）。
  - [x] 带宽与抖动指标较当前基线改善。

## 4) P1（四到八周）

### T-004 快照差量与压缩

- 优先级：P1
- 验收：
  - [x] `WorldSnapshot` 支持 delta 编码。
  - [x] 大量实体场景下网络负载下降（记录压测数据）。

### T-005 存档单一写入源（SSOT）

- 优先级：P1
- 验收：
  - [x] 仅 `SaveFileData v2` 参与写入路径。
  - [x] 旧 schema 不再迁移，直接拒绝。
  - [x] schema 回归测试覆盖核心字段与损坏校验。

### T-006 Redis 后台写队列

- 优先级：P1
- 验收：
  - [x] ECS 主循环不直接承担 Redis I/O。
  - [x] 写入失败重试策略可配置且可观测。

## 5) P2（八周以上）

### T-007 性能基线与预算守护

- 验收：
  - [x] 建立 1080p 场景 FPS/帧时间基线报告。
  - [x] 场景装饰系统在不同配置机器有对比数据。

### T-008 在线生态能力

- 验收：
  - [x] 排行榜/回放链路可跑通最小闭环。
  - [x] 云存档跨设备流程可验证。

## 6) 执行与追踪方式

- 每个任务 PR 必须更新：
  - `docs/bevy-upgrade-regression-checklist.md`
  - `CHANGELOG.md`
  - 本文件对应任务状态
- 每周固定刷新一次 `docs/2026-upgrade-status.md`。
